<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¸ªäººè®¾ç½® - æ—¥ç¨‹ç®¡ç†</title>
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
      padding: 20px;
      gap: 20px;
    }
    
    /* å·¦ä¾§ä¸ªäººä¿¡æ¯ */
    .profile-section {
      flex: 1;
      background: white;
      border-radius: 12px; /* ç•¥å¾®å¢å¤§åœ†è§’ */
      padding: 30px 25px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); /* å¢å¼ºé˜´å½±æ•ˆæœ */
      min-width: 300px;
      max-width: 350px;
      display: flex; /* ç¡®ä¿å†…å®¹å±…ä¸­æˆ–åˆç†å¸ƒå±€ */
      flex-direction: column;
    }

    .profile-section h2 {
      color: #409EFF;
      margin-bottom: 25px; /* å¢å¤§æ ‡é¢˜ä¸‹æ–¹é—´è· */
      padding-bottom: 10px;
      border-bottom: 3px solid #409EFF; /* ç•¥å¾®åŠ ç²—åˆ†å‰²çº¿ */
      font-size: 22px; /* æ ‡é¢˜å­—ä½“è°ƒå¤§ */
      text-align: center; /* æ ‡é¢˜å±…ä¸­ */
    }

    .info-item {
      margin: 15px 0; /* è°ƒæ•´é¡¹ç›®é—´è· */
      padding: 10px 0;
      background: #f0f7ff; /* æµ…è“è‰²èƒŒæ™¯ä»¥çªå‡ºæ¯ä¸ªä¿¡æ¯å— */
      border-left: 5px solid #409EFF; /* å¢åŠ å·¦ä¾§è“è‰²æŒ‡ç¤ºæ¡ */
      border-radius: 4px;
      padding-left: 15px;
    }

    .info-label {
      color: #666;
      font-size: 14px; /* æ ‡ç­¾å­—ä½“ä¿æŒæ¸…æ™° */
      font-weight: 500; /* è°ƒæ•´å­—é‡ */
      margin-bottom: 4px; /* æ ‡ç­¾å’Œå€¼ä¹‹é—´çš„é—´è· */
    }

    .info-value {
      color: #333;
      font-size: 18px; /* **é‡ç‚¹ï¼šè°ƒå¤§ä¿¡æ¯å€¼å­—ä½“** */
      font-weight: bold; /* çªå‡ºä¿¡æ¯å€¼ */
      /* padding: 8px 0; (ç§»é™¤åŸå§‹çš„paddingï¼Œä½¿ç”¨æ–°çš„å¸ƒå±€) */
    }
    
    /* å³ä¾§ä¸»å†…å®¹ */
    .main-section {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* æ—¥å†å®¹å™¨ */
    .calendar-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* æ—¥ç¨‹è¡¨æ ¼ */
    .schedule-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* è¡¨æ ¼æ ·å¼ */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      flex: 1;
    }
    
    .schedule-table th {
      background: #f8f9fa;
      padding: 12px 15px;
      text-align: left;
      font-weight: bold;
      color: #495057;
      border-bottom: 2px solid #e9ecef;
    }
    
    .schedule-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .schedule-table tr:hover {
      background: #f8f9fa;
    }
    
    /* ä¼˜å…ˆçº§æ ‡ç­¾ */
    .priority-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .priority-high {
      background: #fdecea;
      color: #f56c6c;
    }
    
    .priority-medium {
      background: #fcf4e8;
      color: #e6a23c;
    }
    
    .priority-low {
      background: #f0f9eb;
      color: #67c23a;
    }
    
    /* çŠ¶æ€æ ‡ç­¾ */
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-pending {
      background: #ecf5ff;
      color: #409EFF;
    }
    
    .status-completed {
      background: #f0f9eb;
      color: #67c23a;
    }
    
    /* æŒ‰é’®ç»„ */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .complete-btn {
      background: #67c23a;
      color: white;
    }
    
    .complete-btn:hover {
      background: #5daf34;
    }
    
    .edit-btn {
      background: #409EFF;
      color: white;
    }
    
    .edit-btn:hover {
      background: #337ecc;
    }
    
    .delete-btn {
      background: #f56c6c;
      color: white;
    }
    
    .delete-btn:hover {
      background: #dd6161;
    }
    
    /* æ·»åŠ æ—¥ç¨‹æŒ‰é’® */
    .add-schedule-btn {
      background: #409EFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 20px;
      align-self: flex-start;
    }
    
    .add-schedule-btn:hover {
      background: #337ecc;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      width: 500px;
      margin: 50px auto;
      border-radius: 8px;
      padding: 30px;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 30px;
    }
    
    .cancel-btn {
      background: #f0f0f0;
      color: #666;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .submit-btn {
      background: #409EFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .no-schedules {
      text-align: center;
      color: #999;
      padding: 50px 0;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .profile-actions {
      margin-top: 24px;
      display: flex;
      gap: 12px;
    }

    .profile-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .edit-btn {
      background-color: #409EFF;
      color: white;
    }
    .edit-btn:hover {
      background-color: #337ecc;
    }

    .reset-btn {
      background-color: #f56c6c;
      color: white;
    }
    .reset-btn:hover {
      background-color: #dd6161;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      
      .profile-section {
        max-width: none;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- å·¦ä¾§ï¼šä¸ªäººä¿¡æ¯ -->
  <div class="profile-section">
    <h2>ä¸ªäººä¿¡æ¯</h2>
    <div class="info-item">
      <div class="info-label">ç”¨æˆ·IDï¼š</div>
      <div class="info-value" id="user-id">åŠ è½½ä¸­...</div>
    </div>
    <div class="info-item">
      <div class="info-label">ç”¨æˆ·åï¼š</div>
      <div class="info-value" id="username">åŠ è½½ä¸­...</div>
    </div>
    <div class="info-item">
      <div class="info-label">çœŸå®å§“åï¼š</div>
      <div class="info-value" id="real-name">åŠ è½½ä¸­...</div>
    </div>
    <div class="info-item">
      <div class="info-label">è§’è‰²ï¼š</div>
      <div class="info-value" id="role">åŠ è½½ä¸­...</div>
    </div>
    <div class="info-item">
      <div class="info-label">å­¦é™¢åç§°ï¼š</div>
      <div class="info-value" id="college-name">åŠ è½½ä¸­...</div>
    </div>
    <div class="profile-actions" style="margin-top: 24px; display: flex; gap: 12px;">
      <button id="editUsernameBtn" class="profile-btn edit-btn">âœï¸ ä¿®æ”¹ç”¨æˆ·å</button>
      <button id="resetPasswordBtn" class="profile-btn reset-btn">ğŸ”’ å¿˜è®°å¯†ç </button>
    </div>
  </div>

  <!-- å³ä¾§ï¼šä¸»å†…å®¹ -->
  <div class="main-section">
    <!-- æ—¥å†åŒºåŸŸ -->
    <div class "calendar-container">
      <div id="calendar"></div>
    </div>

    <!-- æ—¥ç¨‹è¡¨æ ¼åŒºåŸŸ -->
    <div class="schedule-container">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>æˆ‘çš„æ—¥ç¨‹</h2>
        <button class="add-schedule-btn" id="addScheduleBtn">+ æ·»åŠ æ–°æ—¥ç¨‹</button>
      </div>
      
      <table class="schedule-table" id="scheduleTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>æ ‡é¢˜</th>
            <th>ä¼˜å…ˆçº§</th>
            <th>çŠ¶æ€</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>æˆªæ­¢æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="scheduleTbody">
          <!-- æ—¥ç¨‹æ•°æ®å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
        </tbody>
      </table>
      <div class="no-schedules" id="noSchedules">æš‚æ— æ—¥ç¨‹å®‰æ’</div>
    </div>
  </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘æ—¥ç¨‹æ¨¡æ€æ¡† -->
<div class="modal" id="scheduleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">æ·»åŠ æ–°æ—¥ç¨‹</h3>
      <button class="close-btn" id="closeModalBtn">&times;</button>
    </div>
    <form id="scheduleForm">
      <input type="hidden" id="taskId" value="">
      
      <div class="form-group">
        <label for="title">æ ‡é¢˜ *</label>
        <input type="text" id="title" required maxlength="200">
      </div>
      
      <div class="form-group">
        <label for="eventDate">æ—¥æœŸ *</label>
        <input type="date" id="eventDate" required>
      </div>
      
      <div class="form-group">
        <label for="priority">ä¼˜å…ˆçº§</label>
        <select id="priority">
          <option value="low">ä½</option>
          <option value="medium" selected>ä¸­</option>
          <option value="high">é«˜</option>
        </select>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="cancel-btn" id="cancelBtn">å–æ¶ˆ</button>
        <button type="submit" class="submit-btn">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>


<!-- ä¿®æ”¹ç”¨æˆ·å Modal -->
<div class="modal" id="editUsernameModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä¿®æ”¹ç”¨æˆ·å</h3>
      <button class="close-btn">&times;</button>
    </div>
    <form id="editUsernameForm">
      <div class="form-group">
        <label for="newUsername">æ–°ç”¨æˆ·å *</label>
        <input type="text" id="newUsername" required minlength="3" maxlength="30" placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·å">
        <small id="usernameError" style="color:#f56c6c; display:none; margin-top:4px;"></small>
      </div>
      <div class="modal-footer">
        <button type="button" class="cancel-btn">å–æ¶ˆ</button>
        <button type="submit" class="submit-btn">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<!-- å¿˜è®°å¯†ç  Modal -->
<div class="modal" id="resetPasswordModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>é‡ç½®å¯†ç </h3>
      <button class="close-btn">&times;</button>
    </div>
    <form id="resetPasswordForm">
      <div class="form-group">
        <label for="oldPassword">å½“å‰å¯†ç  *</label>
        <input type="password" id="oldPassword" required placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
      </div>
      <div class="form-group">
        <label for="newPassword">æ–°å¯†ç  *</label>
        <input type="password" id="newPassword" required minlength="6" placeholder="è‡³å°‘6ä½">
      </div>
      <div class="form-group">
        <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç  *</label>
        <input type="password" id="confirmPassword" required placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        <small id="passwordError" style="color:#f56c6c; display:none; margin-top:4px;"></small>
      </div>
      <div class="modal-footer">
        <button type="button" class="cancel-btn">å–æ¶ˆ</button>
        <button type="submit" class="submit-btn">ç¡®è®¤é‡ç½®</button>
      </div>
    </form>
  </div>
</div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/zh-cn.js"></script>

<script>
  // å…¨å±€å˜é‡
  let currentUser = {};
  let currentTasks = [];
  let isEditing = false;
  let currentEditingId = null;
  
  // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // 1. åŠ è½½ç”¨æˆ·ä¿¡æ¯
    loadUserInfo();
    
    // 2. åˆå§‹åŒ–æ—¥å†
    initCalendar();
    
    // 3. åŠ è½½æ—¥ç¨‹æ•°æ®
    loadTasks();
    
    // 4. ç»‘å®šäº‹ä»¶
    bindEvents();
  });
  
  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  async function loadUserInfo() {
    try {
      const userInfoStr = localStorage.getItem('userInfo');
      if (userInfoStr) {
        currentUser = JSON.parse(userInfoStr);
        
        // å¡«å……ç”¨æˆ·ä¿¡æ¯åˆ°é¡µé¢
        document.getElementById('user-id').textContent = currentUser.user_id || 'æš‚æ— ';
        document.getElementById('username').textContent = currentUser.username || 'æš‚æ— ';
        document.getElementById('real-name').textContent = currentUser.real_name || 'æš‚æ— ';
        document.getElementById('role').textContent = currentUser.role || 'æš‚æ— ';

        await loadColleges(); // å¦‚æœè¿˜æ²¡åŠ è½½è¿‡
        const collegeName = getCollegeNameById(currentUser.college_id);
        document.getElementById('college-name').textContent = collegeName

      } else {
        console.warn('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•');
        // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
  }
  
  // è·å–å­¦é™¢åˆ—è¡¨å¹¶ç¼“å­˜
  async function loadColleges() {
    try {
      const response = await fetch('/user/api/colleges');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const result = await response.json();
      if (result.code === 200) {
        collegeList = result.data; // ç¼“å­˜èµ·æ¥ï¼Œé¿å…é‡å¤è¯·æ±‚
        console.log('ã€è°ƒè¯•ã€‘å­¦é™¢ API æ•°æ®:', result);
      }
    } catch (error) {
      console.error('åŠ è½½å­¦é™¢åˆ—è¡¨å¤±è´¥:', error);
      collegeList = []; // é™çº§å¤„ç†
    }
  }

  // æ ¹æ® college_id è·å–å­¦é™¢åç§°
  function getCollegeNameById(collegeId) {
    if (!collegeId) return 'æš‚æ— ';
    
    const college = collegeList.find(c => c.college_id == collegeId); // æ³¨æ„ï¼šç”¨ == å…¼å®¹å­—ç¬¦ä¸²/æ•°å­—
    console.log('ã€è°ƒè¯•ã€‘æ ¹æ® college_id è·å–å­¦é™¢åç§°:', college);
    return college ? college.college_name : `æœªçŸ¥å­¦é™¢(ID:${collegeId})`;
  }

  // åˆå§‹åŒ–æ—¥å†
  function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'zh-cn',
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: function(fetchInfo, successCallback, failureCallback) {
        // ä»APIè·å–æ—¥å†äº‹ä»¶
        fetchCalendarEvents(fetchInfo.start, fetchInfo.end)
          .then(events => successCallback(events))
          .catch(error => {
            console.error('è·å–æ—¥å†äº‹ä»¶å¤±è´¥:', error);
            failureCallback(error);
          });
      },
      eventClick: function(info) {
        // ç‚¹å‡»äº‹ä»¶è·³è½¬åˆ°ç¼–è¾‘
        editTask(info.event.id);
      },
      dateClick: function(info) {
        // ç‚¹å‡»æ—¥æœŸæ·»åŠ æ—¥ç¨‹
        openAddModal(info.dateStr);
      }
    });
    
    calendar.render();
    window.calendar = calendar;
  }
  
  // è·å–æ—¥å†äº‹ä»¶
  async function fetchCalendarEvents(start, end) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    
    if (!userInfo) {
      console.warn('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•');
      return [];
    }
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/user/api/tasks/calendar/?user_id=${userInfo.user_id}&start=${start.toISOString().split('T')[0]}&end=${end.toISOString().split('T')[0]}`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        return data.data;
      } else {
        console.error('è·å–æ—¥å†äº‹ä»¶å¤±è´¥:', data.message);
        return [];
      }
    } catch (error) {
      console.error('è·å–æ—¥å†äº‹ä»¶å¤±è´¥:', error);
      return [];
    }
  }
  
  // è·å–ä¼˜å…ˆçº§æ ‡ç­¾
  function getPriorityLabel(priority) {
    switch(priority) {
      case 'high': 
        return '<span class="priority-badge priority-high">é«˜</span>';
      case 'medium': 
        return '<span class="priority-badge priority-medium">ä¸­</span>';
      case 'low': 
        return '<span class="priority-badge priority-low">ä½</span>';
      default: 
        return '<span class="priority-badge priority-medium">ä¸­</span>';
    }
  }
  
  // è·å–çŠ¶æ€æ ‡ç­¾
  function getStatusLabel(status) {
    if (status === 'completed') {
      return '<span class="status-badge status-completed">å·²å®Œæˆ</span>';
    } else {
      return '<span class="status-badge status-pending">å¾…åŠ</span>';
    }
  }
  
  // è·å–ä¼˜å…ˆçº§é¢œè‰²
  function getPriorityColor(priority) {
    switch(priority) {
      case 'high': return '#f56c6c';
      case 'medium': return '#e6a23c';
      case 'low': return '#67c23a';
      default: return '#409EFF';
    }
  }
  
  // åŠ è½½ä»»åŠ¡æ•°æ®
  async function loadTasks() {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo || !userInfo.user_id) {
      console.warn('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•');
      showNoTasks();
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const url = `/user/api/tasks?user_id=${encodeURIComponent(userInfo.user_id)}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        currentTasks = data.data || [];
        renderScheduleTable();
      } else {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', data.message);
        showNoTasks();
      }
    } catch (error) {
      console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
      showNoTasks();
    }
  }
  
  // æ˜¾ç¤ºæ— ä»»åŠ¡æç¤º
  function showNoTasks() {
    const tbody = document.getElementById('scheduleTbody');
    const noSchedules = document.getElementById('noSchedules');
    tbody.innerHTML = '';
    noSchedules.style.display = 'flex';
  }
  
  // æ¸²æŸ“ä»»åŠ¡è¡¨æ ¼
  function renderScheduleTable() {
    const tbody = document.getElementById('scheduleTbody');
    const noSchedules = document.getElementById('noSchedules');
    
    if (!currentTasks || currentTasks.length === 0) {
      showNoTasks();
      return;
    }
    
    noSchedules.style.display = 'none';
    
    let html = '';
    currentTasks.forEach((task) => {
      const createTime = new Date(task.created_at).toLocaleString('zh-CN');
      const updateTime = new Date(task.updated_at).toLocaleString('zh-CN');
      const scheduledDate = task.scheduled_date;
      
      html += `
        <tr>
          <td>${task.task_id}</td>
          <td>${task.title}</td>
          <td>${getPriorityLabel(task.priority)}</td>
          <td>${getStatusLabel(task.status)}</td>
          <td>${createTime}</td>
          <td>${scheduledDate}</td>
          <td>
            <div class="action-buttons">
              ${task.status === 'pending' ? 
                `<button class="action-btn complete-btn" onclick="completeTask(${task.task_id})">å®Œæˆ</button>` :
                ''
              }
              <button class="action-btn edit-btn" onclick="editTask(${task.task_id})">ä¿®æ”¹</button>
              <button class="action-btn delete-btn" onclick="deleteTask(${task.task_id})">åˆ é™¤</button>
            </div>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }


  // æ‰“å¼€ä¿®æ”¹ç”¨æˆ·åå¼¹çª—
  document.getElementById('editUsernameBtn').addEventListener('click', () => {
    document.getElementById('newUsername').value = currentUser.username || '';
    document.getElementById('usernameError').style.display = 'none';
    openModal('editUsernameModal');
  });

  // æ‰“å¼€é‡ç½®å¯†ç å¼¹çª—
  document.getElementById('resetPasswordBtn').addEventListener('click', () => {
    document.getElementById('resetPasswordForm').reset();
    document.getElementById('passwordError').style.display = 'none';
    openModal('resetPasswordModal');
  });

  // æ‰“å¼€æ¨¡æ€æ¡†
  function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.style.display = 'block';
    } else {
      console.warn(`[openModal] æ‰¾ä¸åˆ° ID ä¸º "${id}" çš„æ¨¡æ€æ¡†`);
    }
  }

  // å…³é—­æ¨¡æ€æ¡†
  document.querySelectorAll('.close-btn, .cancel-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      this.closest('.modal').style.display = 'none';
    });
  });

  // æäº¤ä¿®æ”¹ç”¨æˆ·å
  document.getElementById('editUsernameForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newUsername = document.getElementById('newUsername').value.trim();
    const errorEl = document.getElementById('usernameError');

    if (newUsername === currentUser.username) {
      errorEl.textContent = 'æ–°ç”¨æˆ·åä¸èƒ½ä¸å½“å‰ç›¸åŒ';
      errorEl.style.display = 'block';
      return;
    }
    
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ä¸­çš„ user_id
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    const userId = userInfo && userInfo.user_id ? userInfo.user_id : null;

    if (!userId) {
      errorEl.textContent = 'æ— æ³•è·å–ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•';
      errorEl.style.display = 'block';
      return;
    }
    
    try {
      const res = await fetch('/user/api/update-username', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_username: newUsername, user_id: userId })
      });

      const result = await res.json();
      if (result.code === 200) {
        alert('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼');
        currentUser.username = newUsername;
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        document.getElementById('username').textContent = newUsername;
        document.getElementById('editUsernameModal').style.display = 'none';
      } else {
        errorEl.textContent = result.message || 'ä¿®æ”¹å¤±è´¥';
        errorEl.style.display = 'block';
      }
    } catch (err) {
      console.error(err);
      errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
      errorEl.style.display = 'block';
    }
  });

  // æäº¤ä¿®æ”¹å¯†ç 
  document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const oldPass = document.getElementById('oldPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;
    const errorEl = document.getElementById('passwordError');

    if (newPass !== confirmPass) {
      errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
      errorEl.style.display = 'block';
      return;
    }

    if (newPass.length < 6) {
      errorEl.textContent = 'æ–°å¯†ç è‡³å°‘6ä½';
      errorEl.style.display = 'block';
      return;
    }

    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ä¸­çš„ user_id
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    const userId = userInfo && userInfo.user_id ? userInfo.user_id : null;

    if (!userId) {
      errorEl.textContent = 'æ— æ³•è·å–ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•';
      errorEl.style.display = 'block';
      return;
    }

    try {
      const res = await fetch('/user/api/change-password', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId, // æ·»åŠ ç”¨æˆ·IDåˆ°è¯·æ±‚ä½“ä¸­
          old_password: oldPass,
          new_password: newPass
        })
      });

      const result = await res.json();
      if (result.code === 200) {
        alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•');
        localStorage.removeItem('userInfo');
        window.location.href = '/user/login';
      } else {
        errorEl.textContent = result.message || 'ä¿®æ”¹å¤±è´¥';
        errorEl.style.display = 'block';
      }
    } catch (err) {
      console.error(err);
      errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
      errorEl.style.display = 'block';
    }
  });
  
  // å®Œæˆä»»åŠ¡
  async function completeTask(taskId) {
    if (!confirm('ç¡®è®¤å®Œæˆæ­¤ä»»åŠ¡å—ï¼Ÿ')) return;
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/user/api/tasks/${taskId}/complete`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        alert('ä»»åŠ¡å·²å®Œæˆ');
        await loadTasks();
        if (window.calendar) {
          window.calendar.refetchEvents();
        }
      } else {
        alert('æ“ä½œå¤±è´¥: ' + data.message);
      }
    } catch (error) {
      console.error('å®Œæˆä»»åŠ¡å¤±è´¥:', error);
      alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  // åˆ é™¤ä»»åŠ¡
  async function deleteTask(taskId) {
    if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
    
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/user/api/tasks/${taskId}/delete`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        alert('åˆ é™¤æˆåŠŸ');
        currentTasks = currentTasks.filter(task => task.task_id !== taskId);
        renderScheduleTable();
        if (window.calendar) {
          window.calendar.refetchEvents();
        }
      } else {
        alert('åˆ é™¤å¤±è´¥: ' + data.message);
      }
    } catch (error) {
      console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
      alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  // ç¼–è¾‘ä»»åŠ¡
  async function editTask(taskId) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo) {
      alert('è¯·å…ˆç™»å½•');
      return;
    }
    try {
      const token = localStorage.getItem('token');
      const url = `/user/api/tasks/${taskId}?user_id=${userInfo.user_id}`;
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        const task = data.data;
        if (task) {
          isEditing = true;
          currentEditingId = taskId;
          
          document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡';
          document.getElementById('taskId').value = task.task_id;
          document.getElementById('title').value = task.title;
          document.getElementById('eventDate').value = task.scheduled_date;
          //document.getElementById('description').value = task.description || '';
          document.getElementById('priority').value = task.priority;
          
          openModal('scheduleModal');
        } else {
          alert('æœªæ‰¾åˆ°è¯¥ä»»åŠ¡');
        }
      } else {
        alert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + data.message);
      }
    } catch (error) {
      console.error('ç¼–è¾‘ä»»åŠ¡å¤±è´¥:', error);
      alert('åŠ è½½ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
  function openAddModal(dateStr) {
    isEditing = false;
    currentEditingId = null;
    
    document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°ä»»åŠ¡';
    document.getElementById('scheduleForm').reset();
    document.getElementById('taskId').value = '';
    
    if (dateStr) {
      document.getElementById('eventDate').value = dateStr.split('T')[0];
    } else {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').value = today;
    }
    
    openModal();
  }
  
  // å…³é—­æ¨¡æ€æ¡†
  function closeModal() {
    document.getElementById('scheduleModal').style.display = 'none';
    isEditing = false;
    currentEditingId = null;
  }
  
  // ä¿å­˜ä»»åŠ¡ï¼ˆåˆ›å»ºæˆ–æ›´æ–°ï¼‰
  async function saveTask(taskData) {
    const userInfo = JSON.parse(localStorage.getItem('userInfo'));
    if (!userInfo) {
      throw new Error('æœªç™»å½•ï¼Œæ— æ³•ä¿å­˜ä»»åŠ¡');
    }

    const payload = {
    ...taskData,
    user_id: userInfo.user_id  // â† å…³é”®ï¼šåŠ åˆ° body é‡Œ
    };

    const url = isEditing 
      ? `/user/api/tasks/${currentEditingId}/update`
      : `/user/api/tasks/create`;

    const method = isEditing ? 'PUT' : 'POST';

    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload),
      credentials: 'same-origin' // 
    });

    return await response.json();
  }
  
  // ç»‘å®šäº‹ä»¶
  function bindEvents() {
    // æ·»åŠ ä»»åŠ¡æŒ‰é’®
    document.getElementById('addScheduleBtn').addEventListener('click', () => {
      openAddModal();
    });
    
    // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®
    //document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    //document.getElementById('cancelBtn').addEventListener('click', closeModal);
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('scheduleModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('scheduleModal')) {
        closeModal();
      }
    });
    
    // è¡¨å•æäº¤
    document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const taskData = {
        title: document.getElementById('title').value.trim(),
        scheduled_date: document.getElementById('eventDate').value,
        //description: document.getElementById('description').value.trim(),
        priority: document.getElementById('priority').value
      };
      
      if (!taskData.title) {
        alert('è¯·è¾“å…¥æ ‡é¢˜');
        return;
      }
      
      if (!taskData.scheduled_date) {
        alert('è¯·é€‰æ‹©æ—¥æœŸ');
        return;
      }
      
      try {
        const result = await saveTask(taskData);
        
        if (result.code === 201 || result.code === 200) {
          alert(isEditing ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
          closeModal();
          await loadTasks();
          if (window.calendar) {
            window.calendar.refetchEvents();
          }
        } else {
          alert((isEditing ? 'æ›´æ–°å¤±è´¥' : 'æ·»åŠ å¤±è´¥') + ': ' + result.message);
        }
      } catch (error) {
        console.error('ä¿å­˜ä»»åŠ¡å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    });
  }
</script>
</body>
</html>