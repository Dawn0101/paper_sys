<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>论文概览分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#86909C',
            light: '#F2F3F5',
            dark: '#1D2129'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-item {
        @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
      }
      .sidebar-item.active {
        @apply bg-primary/10 text-primary font-medium;
      }
      .sidebar-item:hover:not(.active) {
        @apply bg-gray-100;
      }
      .card {
        @apply bg-white rounded-xl shadow-sm border border-gray-200 p-5 transition-all hover:shadow-md;
      }
      .chart-container {
        @apply w-full h-[400px] mt-4;
      }
      .chart-container-inner {
        @apply w-full h-full;
      }
      
      /* 自定义滚动条 */
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 #f1f1f1;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark h-screen flex overflow-hidden">
  <!-- 左侧导航栏 -->
  <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 transition-all duration-300 ease-in-out">
    <div class="p-5 border-b border-gray-200">
      <h1 class="text-xl font-bold text-primary flex items-center gap-2">
        <i class="fa fa-graduation-cap"></i>
        <span>学术资源管理系统</span>
      </h1>
    </div>

    <nav class="p-4">
      <h2 class="text-xs uppercase text-neutral font-semibold mb-3 px-4">控制台</h2>
      <ul class="space-y-1">
        <li>
          <a href="/student/overview" class="sidebar-item active">
            <i class="fa fa-bar-chart w-5 text-center"></i>
            <span>论文概览</span>
          </a>
        </li>
        <!-- 已移除第二条跳转按钮 -->
      </ul>

      <h2 class="text-xs uppercase text-neutral font-semibold mb-3 px-4 mt-8">其他功能</h2>
      <ul class="space-y-1">
        <li>
          <a href="#" class="sidebar-item text-neutral cursor-not-allowed">
            <i class="fa fa-star-o w-5 text-center"></i>
            <span>收藏论文</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- 主内容区 -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- 顶部导航 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
      <h2 class="text-lg font-semibold">论文数据分析概览</h2>
      <div class="flex items-center gap-4">
        <button class="text-neutral hover:text-primary transition-colors" id="refresh-data">
          <i class="fa fa-refresh text-lg"></i>
        </button>
        <div class="flex items-center gap-2">
          <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover border border-gray-200">
          <span class="text-sm font-medium" id="current-username">当前用户</span>
        </div>
      </div>
    </header>

    <!-- 内容区域 -->
    <div class="flex-1 overflow-y-auto p-6 bg-gray-50 custom-scrollbar">
      <!-- 数据概览卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-neutral text-sm">总论文数</p>
              <h3 class="text-2xl font-bold text-primary" id="total-papers">--</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <i class="fa fa-file-text-o text-primary text-xl"></i>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-neutral text-sm">分类数量</p>
              <h3 class="text-2xl font-bold text-secondary" id="total-categories">--</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center">
              <i class="fa fa-tags text-secondary text-xl"></i>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-neutral text-sm">年份跨度</p>
              <h3 class="text-2xl font-bold text-orange-500" id="year-range">--</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center">
              <i class="fa fa-calendar text-orange-500 text-xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- 图表区域 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- 分类柱状图 -->
        <div class="card">
          <h3 class="font-medium mb-2">论文分类分布</h3>
          <div class="chart-container" id="category-chart-container">
            <!-- 等待加载提示 -->
            <div id="category-loading" class="flex items-center justify-center h-full text-neutral">
              <i class="fa fa-spinner fa-spin text-primary text-2xl mr-3"></i>
              <span>加载分类数据...</span>
            </div>
            <!-- 图表容器 -->
            <div id="category-chart" class="chart-container-inner hidden"></div>
          </div>
        </div>
        <!-- 年份折线图 -->
        <div class="card">
          <h3 class="font-medium mb-2">论文发表年份趋势</h3>
          <div class="chart-container" id="year-chart-container">
            <!-- 等待加载提示 -->
            <div id="year-loading" class="flex items-center justify-center h-full text-neutral">
              <i class="fa fa-spinner fa-spin text-primary text-2xl mr-3"></i>
              <span>加载年份数据...</span>
            </div>
            <!-- 图表容器 -->
            <div id="year-chart" class="chart-container-inner hidden"></div>
          </div>
        </div>
      </div>

      <!-- 新增：学院学生论文点击量排行卡片 -->
      <div class="card mb-6">
        <h3 class="font-medium mb-2">学院学生论文点击量排行</h3>
        <div class="w-full" id="click-ranking-container">
          <!-- 加载提示 -->
          <div id="click-ranking-loading" class="flex items-center justify-center h-48 text-neutral">
            <i class="fa fa-spinner fa-spin text-primary text-2xl mr-3"></i>
            <span>加载点击量数据...</span>
          </div>
          <!-- 排行列表容器 -->
          <div id="click-ranking-list" class="hidden">
            <div class="overflow-x-auto custom-scrollbar">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-neutral border-b">
                  <tr>
                    <th class="px-4 py-3 rounded-l-lg">排名</th>
                    <th class="px-4 py-3">学生姓名</th>
                    <th class="px-4 py-3">用户名</th>
                    <th class="px-4 py-3 rounded-r-lg">点击次数</th>
                  </tr>
                </thead>
                <tbody id="click-ranking-tbody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
            <!-- 无数据提示 -->
            <div id="click-ranking-empty" class="hidden flex items-center justify-center h-48 text-neutral">
              <i class="fa fa-bar-chart text-primary text-2xl mr-3"></i>
              <span>暂无学生点击数据</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 未登录提示 -->
      <div id="not-logged-in" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
          <i class="fa fa-user-times text-2xl text-neutral"></i>
        </div>
        <h3 class="text-lg font-medium mb-1">未登录</h3>
        <p class="text-neutral max-w-md mx-auto mb-4">请先登录系统以查看论文概览数据</p>
        <a href="/user/login" class="btn bg-primary text-white hover:bg-primary/90 inline-block px-4 py-2 rounded-lg">
          前往登录
        </a>
      </div>
    </div>
  </main>

  <script>
    // 全局变量
    let currentUser = {};
    let categoryChart = null;
    let yearChart = null;

    // DOM元素
    const totalPapersEl = document.getElementById('total-papers');
    const totalCategoriesEl = document.getElementById('total-categories');
    const yearRangeEl = document.getElementById('year-range');
    const refreshBtn = document.getElementById('refresh-data');
    const currentUsernameEl = document.getElementById('current-username');
    const notLoggedInEl = document.getElementById('not-logged-in');
    const categoryLoadingEl = document.getElementById('category-loading');
    const yearLoadingEl = document.getElementById('year-loading');
    const categoryChartEl = document.getElementById('category-chart');
    const yearChartEl = document.getElementById('year-chart');
    // 新增：点击排行相关DOM元素
    const clickRankingLoadingEl = document.getElementById('click-ranking-loading');
    const clickRankingListEl = document.getElementById('click-ranking-list');
    const clickRankingTbodyEl = document.getElementById('click-ranking-tbody');
    const clickRankingEmptyEl = document.getElementById('click-ranking-empty');

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      refreshBtn.addEventListener('click', loadAllStatsData);
    });

    // 获取用户信息（从localStorage）
    function loadUserInfo() {
      try {
        const userInfoStr = localStorage.getItem('userInfo');
        if (userInfoStr) {
          currentUser = JSON.parse(userInfoStr);
          console.log('加载用户信息:', currentUser); // 调试日志
          currentUsernameEl.textContent = currentUser.real_name || currentUser.username;
          
          // 校验college_id是否存在
          if (!currentUser.college_id) {
            showToast('当前管理员缺少学院ID信息', 'error');
            // 隐藏主要内容
            document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3').classList.add('hidden');
            document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-2').classList.add('hidden');
            document.querySelector('.card.mb-6').classList.add('hidden');
            return;
          }

          // 显示主要内容，隐藏未登录提示
          document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3').classList.remove('hidden');
          document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-2').classList.remove('hidden');
          document.querySelector('.card.mb-6').classList.remove('hidden');
          notLoggedInEl.classList.add('hidden');
          // 初始化图表并加载数据
          initCharts();
          loadAllStatsData();
        } else {
          console.warn('未找到用户信息，请先登录');
          // 隐藏主要内容，显示未登录提示
          document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3').classList.add('hidden');
          document.querySelector('.grid.grid-cols-1.lg\\:grid-cols-2').classList.add('hidden');
          document.querySelector('.card.mb-6').classList.add('hidden');
          notLoggedInEl.classList.remove('hidden');
          currentUsernameEl.textContent = '未登录';
        }
      } catch (error) {
        console.error('加载用户信息失败:', error);
        showToast('用户信息加载失败', 'error');
      }
    }

    // 初始化图表实例
    function initCharts() {
      // 确保图表容器可见
      categoryChartEl.classList.remove('hidden');
      yearChartEl.classList.remove('hidden');
      
      // 销毁已存在的图表实例
      if (categoryChart && !categoryChart.isDisposed()) {
        categoryChart.dispose();
      }
      if (yearChart && !yearChart.isDisposed()) {
        yearChart.dispose();
      }
      
      // 创建新的图表实例
      categoryChart = echarts.init(categoryChartEl);
      yearChart = echarts.init(yearChartEl);
      
      // 窗口自适应
      window.addEventListener('resize', () => {
        categoryChart && !categoryChart.isDisposed() && categoryChart.resize();
        yearChart && !yearChart.isDisposed() && yearChart.resize();
      });
    }

    // 加载所有统计数据（核心修改：调用专属点击统计API）
    async function loadAllStatsData() {
      try {
        if (!currentUser || !currentUser.college_id) {
          showToast('用户信息无效，缺少学院ID', 'error');
          return;
        }

        showToast('正在加载数据...');
        
        // 显示加载状态
        categoryLoadingEl.classList.remove('hidden');
        yearLoadingEl.classList.remove('hidden');
        clickRankingLoadingEl.classList.remove('hidden');
        categoryChartEl.classList.add('hidden');
        yearChartEl.classList.add('hidden');
        clickRankingListEl.classList.add('hidden');

        // 并行请求所有数据（替换为专属点击统计API）
        const [categoryRes, yearRes, clickStatsRes] = await Promise.all([
          fetch('/student/api/stats/category', { method: 'GET' }),
          fetch('/student/api/stats/year', { method: 'GET' }),
          // 核心修改：调用后端提供的专属点击统计API
          fetch(`/college_admin/api/stats/click_history/${currentUser.college_id}`, { method: 'GET' })
        ]);

        // 检查响应状态
        if (!categoryRes.ok || !yearRes.ok || !clickStatsRes.ok) {
          throw new Error(`接口请求失败：分类(${categoryRes.status}) / 年份(${yearRes.status}) / 点击量(${clickStatsRes.status})`);
        }

        // 解析数据
        const categoryData = await categoryRes.json();
        const yearData = await yearRes.json();
        const clickStatsData = await clickStatsRes.json(); // 点击统计数据

        // 校验返回码
        if (categoryData.code !== 200 || yearData.code !== 200 || clickStatsData.code !== 200) {
          throw new Error(`数据返回异常：${[categoryData.message, yearData.message, clickStatsData.message].filter(Boolean).join(' / ')}`);
        }

        // 更新概览卡片
        updateOverviewCards(categoryData.data, yearData.data);
        // 渲染图表
        renderCategoryChart(categoryData.data);
        renderYearChart(yearData.data);
        // 渲染点击量排行（使用专属API返回的数据）
        renderClickRanking(clickStatsData.data.ranking || []);

        showToast('数据加载成功');
      } catch (error) {
        console.error('加载统计数据失败:', error);
        showToast(`加载失败：${error.message}`, 'error');
        // 清空图表加载状态
        categoryLoadingEl.innerHTML = '<div class="flex items-center justify-center h-full text-neutral"><i class="fa fa-exclamation-circle text-primary text-2xl mr-3"></i><span>分类数据加载失败</span></div>';
        yearLoadingEl.innerHTML = '<div class="flex items-center justify-center h-full text-neutral"><i class="fa fa-exclamation-circle text-primary text-2xl mr-3"></i><span>年份数据加载失败</span></div>';
        clickRankingLoadingEl.innerHTML = '<div class="flex items-center justify-center h-full text-neutral"><i class="fa fa-exclamation-circle text-primary text-2xl mr-3"></i><span>点击量数据加载失败</span></div>';
        // 重置概览卡片
        totalPapersEl.textContent = '--';
        totalCategoriesEl.textContent = '--';
        yearRangeEl.textContent = '--';
      }
    }

    // 更新概览卡片数据
    function updateOverviewCards(categoryStats, yearStats) {
      // 计算总论文数
      const totalPapers = categoryStats.categories && categoryStats.counts
        ? categoryStats.counts.reduce((sum, val) => sum + val, 0)
        : 0;
      totalPapersEl.textContent = totalPapers.toLocaleString();

      // 分类数量
      const categoryCount = categoryStats.categories ? categoryStats.categories.length : 0;
      totalCategoriesEl.textContent = categoryCount;

      // 年份跨度
      if (yearStats.years && yearStats.years.length > 0) {
        const minYear = Math.min(...yearStats.years);
        const maxYear = Math.max(...yearStats.years);
        yearRangeEl.textContent = `${maxYear - minYear}年 (${minYear}-${maxYear})`;
      } else {
        yearRangeEl.textContent = '--';
      }
    }

    // 渲染分类柱状图（带滚动条）
    function renderCategoryChart(data) {
      // 隐藏加载提示，显示图表
      categoryLoadingEl.classList.add('hidden');
      categoryChartEl.classList.remove('hidden');
      
      if (!data.categories || data.categories.length === 0) {
        setEmptyChart(categoryChart, '暂无分类数据');
        return;
      }
      
      const categories = data.categories || [];
      const counts = data.counts || [];
      
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: function(params) {
            return `${params[0].name}<br/>论文数量: ${params[0].value}篇`;
          }
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '10%', // 为滚动条留出空间
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: categories,
          axisLabel: { 
            rotate: 45, // 倾斜角度加大
            fontSize: 10,
            interval: 0,
            width: 60,
            overflow: 'truncate',
            ellipsis: '...'
          },
          axisTick: {
            alignWithLabel: true
          }
        },
        yAxis: { 
          type: 'value', 
          name: '论文数量',
          nameTextStyle: {
            fontSize: 12
          }
        },
        dataZoom: [
          {
            type: 'slider', // 滑动条型数据区域缩放组件
            show: categories.length > 8, // 分类数量大于8时显示滚动条
            xAxisIndex: 0,
            start: 0,
            end: Math.min(100, (8 / categories.length) * 100), // 初始显示8个分类
            height: 20,
            bottom: 0,
            borderColor: '#e5e7eb',
            fillerColor: 'rgba(22, 93, 255, 0.1)',
            handleStyle: {
              color: '#165DFF'
            }
          }
        ],
        series: [{
          name: '论文数',
          type: 'bar',
          data: counts,
          itemStyle: {
            color: function(params) {
              const colorList = ['#165DFF', '#36CFC9', '#FF7D00', '#F53F3F', '#722ED1', '#0FC6C2', '#7BC616'];
              return colorList[params.dataIndex % colorList.length];
            }
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}',
            fontSize: 10
          },
          barWidth: '60%'
        }]
      };
      
      categoryChart.setOption(option, true);
    }

    // 渲染年份折线图
    function renderYearChart(data) {
      // 隐藏加载提示，显示图表
      yearLoadingEl.classList.add('hidden');
      yearChartEl.classList.remove('hidden');
      
      if (!data.years || data.years.length === 0) {
        setEmptyChart(yearChart, '暂无年份数据');
        return;
      }
      
      const option = {
        tooltip: { 
          trigger: 'axis', 
          formatter: '{b}年: {c}篇'
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: data.years || [],
          boundaryGap: false,
          axisLabel: {
            fontSize: 12
          }
        },
        yAxis: { 
          type: 'value', 
          name: '发表数量',
          nameTextStyle: {
            fontSize: 12
          }
        },
        series: [{
          name: '发表数量',
          type: 'line',
          data: data.counts || [],
          smooth: true,
          lineStyle: { width: 3, color: '#165DFF' },
          itemStyle: { color: '#165DFF', borderWidth: 2 },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: 'rgba(22, 93, 255, 0.3)' },
              { offset: 1, color: 'rgba(22, 93, 255, 0.05)' }
            ])
          },
          markPoint: {
            data: [
              { type: 'max', name: '最大值' },
              { type: 'min', name: '最小值' }
            ]
          },
          markLine: {
            data: [
              { type: 'average', name: '平均值' }
            ]
          }
        }]
      };
      yearChart.setOption(option, true);
    }

    // 渲染学生点击量排行（适配专属API返回结构）
    function renderClickRanking(rankedStudents) {
      // 隐藏加载提示
      clickRankingLoadingEl.classList.add('hidden');
      clickRankingListEl.classList.remove('hidden');

      // 过滤有点击量的学生（双重校验）
      const validStudents = rankedStudents
        .filter(student => student.click_count !== undefined && student.click_count > 0)
        .slice(0, 10); // 仅显示前10名

      // 无数据处理
      if (validStudents.length === 0) {
        clickRankingEmptyEl.classList.remove('hidden');
        clickRankingTbodyEl.innerHTML = '';
        return;
      }

      // 隐藏无数据提示，渲染排行列表
      clickRankingEmptyEl.classList.add('hidden');
      let rankingHtml = '';
      
      validStudents.forEach((student, index) => {
        // 排名样式（前3名特殊标记）
        let rankClass = '';
        let rankIcon = '';
        if (index === 0) {
          rankClass = 'text-yellow-500 font-bold';
          rankIcon = '<i class="fa fa-trophy mr-1"></i>';
        } else if (index === 1) {
          rankClass = 'text-gray-400 font-bold';
          rankIcon = '<i class="fa fa-trophy mr-1"></i>';
        } else if (index === 2) {
          rankClass = 'text-orange-300 font-bold';
          rankIcon = '<i class="fa fa-trophy mr-1"></i>';
        }

        rankingHtml += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 rounded-l-lg ${rankClass}">${rankIcon}${index + 1}</td>
            <td class="px-4 py-3">${student.real_name || '未知'}</td>
            <td class="px-4 py-3 text-neutral">${student.username || '未知'}</td>
            <td class="px-4 py-3 rounded-r-lg font-medium text-primary">${student.click_count.toLocaleString()}</td>
          </tr>
        `;
      });

      clickRankingTbodyEl.innerHTML = rankingHtml;
    }

    // 设置空图表
    function setEmptyChart(chart, text) {
      chart.setOption({
        title: {
          text: text,
          left: 'center',
          top: 'center',
          textStyle: {
            color: '#86909C',
            fontSize: 14,
            fontWeight: 'normal'
          }
        },
        xAxis: { show: false },
        yAxis: { show: false },
        series: []
      }, true);
    }

    // Toast提示
    function showToast(message, type = 'success') {
      // 移除已有的toast
      const existingToasts = document.querySelectorAll('.custom-toast');
      existingToasts.forEach(toast => toast.remove());

      const toast = document.createElement('div');
      toast.className = `custom-toast fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 transition-all duration-300 transform translate-y-10 opacity-0`;

      if (type === 'success') {
        toast.classList.add('bg-green-50', 'text-green-600', 'border', 'border-green-200');
        toast.innerHTML = `<i class="fa fa-check-circle"></i><span>${message}</span>`;
      } else {
        toast.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-200');
        toast.innerHTML = `<i class="fa fa-exclamation-circle"></i><span>${message}</span>`;
      }

      document.body.appendChild(toast);
      setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
      setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>