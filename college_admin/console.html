<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学院管理员控制台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#86909C',
            light: '#F2F3F5',
            dark: '#1D2129'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-item {
        @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer;
      }
      .sidebar-item.active {
        @apply bg-primary/10 text-primary font-medium;
      }
      .sidebar-item:hover:not(.active) {
        @apply bg-gray-100;
      }
      .btn {
        @apply px-4 py-2 rounded-lg font-medium transition-all duration-200;
      }
      .btn-primary {
        @apply bg-primary text-white hover:bg-primary/90;
      }
      .btn-danger {
        @apply bg-red-50 text-red-600 hover:bg-red-100;
      }
      .btn-outline {
        @apply border border-gray-200 hover:bg-gray-50;
      }
      .table-row-hover {
        @apply hover:bg-gray-50 transition-colors duration-150;
      }
      .form-input {
        @apply w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary;
      }
      
      /* 自定义滚动条 */
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 #f1f1f1;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 text-dark h-screen flex overflow-hidden">
  <!-- 左侧导航栏 -->
  <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 transition-all duration-300 ease-in-out">
    <div class="p-5 border-b border-gray-200">
      <h1 class="text-xl font-bold text-primary flex items-center gap-2">
        <i class="fa fa-graduation-cap"></i>
        <span>学院管理员控制台</span>
      </h1>
    </div>

    <nav class="p-4">
      <h2 class="text-xs uppercase text-neutral font-semibold mb-3 px-4">核心功能</h2>
      <ul class="space-y-1">
        <li>
          <a href="#" class="sidebar-item active" data-tab="click-history">
            <i class="fa fa-history w-5 text-center"></i>
            <span>浏览记录</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-item" data-tab="student-management">
            <i class="fa fa-users w-5 text-center"></i>
            <span>学生管理</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-item" data-tab="paper-management">
            <i class="fa fa-file-text-o w-5 text-center"></i>
            <span>论文管理</span>
          </a>
        </li>
      </ul>

      <!-- 其他功能 -->
      <h2 class="text-xs uppercase text-neutral font-semibold mb-3 px-4 mt-8">其他功能</h2>
      <ul class="space-y-1">
        <li>
          <a href="#" class="sidebar-item text-neutral cursor-not-allowed">
            <i class="fa fa-star-o w-5 text-center"></i>
            <span>收藏论文</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- 主内容区 -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- 顶部导航 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
      <h2 class="text-lg font-semibold" id="main-title">论文浏览记录</h2>
      <div class="flex items-center gap-4">
        <button class="text-neutral hover:text-primary transition-colors" id="refresh-btn">
          <i class="fa fa-refresh text-lg"></i>
        </button>
        <div class="flex items-center gap-2">
          <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover border border-gray-200">
          <span class="text-sm font-medium" id="current-username">当前用户</span>
        </div>
      </div>
    </header>

    <!-- 内容区域 -->
    <div class="flex-1 overflow-y-auto p-6 bg-gray-50 custom-scrollbar">
      <!-- 浏览记录面板 -->
      <div id="click-history-panel" class="tab-panel">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-5 border-b border-gray-200 flex justify-between items-center">
            <h3 class="font-medium">浏览历史记录</h3>
            <div class="text-sm text-neutral">
              共 <span id="total-count" class="text-primary font-medium">0</span> 条记录
            </div>
          </div>

          <!-- 表格区域 -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                  <th class="text-left px-6 py-4 font-medium text-neutral">序号</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">论文标题</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">浏览时间</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">操作</th>
                </tr>
              </thead>
              <tbody id="history-table-body">
                <!-- 加载状态 -->
                <tr>
                  <td colspan="4" class="px-6 py-12 text-center text-neutral">
                    <div class="flex flex-col items-center">
                      <i class="fa fa-spinner fa-spin text-primary text-2xl mb-3"></i>
                      <span>加载中...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 空状态 -->
          <div id="empty-state" class="hidden px-6 py-16 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
              <i class="fa fa-folder-open-o text-2xl text-neutral"></i>
            </div>
            <h3 class="text-lg font-medium mb-1">暂无浏览记录</h3>
            <p class="text-neutral max-w-md mx-auto">您还没有浏览过任何论文，浏览论文后会在这里显示记录</p>
          </div>
        </div>
      </div>

      <!-- 学生管理面板 -->
      <div id="student-management-panel" class="tab-panel hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-5 border-b border-gray-200 flex flex-wrap justify-between items-center gap-4">
            <h3 class="font-medium">学生管理</h3>
            <div class="flex items-center gap-3">
              <div class="relative">
                <input type="text" id="student-search-input" placeholder="搜索学生..." class="form-input pl-9 pr-4 py-2 w-64">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral"></i>
              </div>
              <button id="student-search-btn" class="btn btn-outline">
                <i class="fa fa-search mr-1"></i> 搜索
              </button>
            </div>
          </div>

          <!-- 表格区域 -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                  <th class="text-left px-6 py-4 font-medium text-neutral">序号</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">用户名</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">真实姓名</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">操作</th>
                </tr>
              </thead>
              <tbody id="student-table-body">
                <!-- 加载状态 -->
                <tr>
                  <td colspan="4" class="px-6 py-12 text-center text-neutral">
                    <div class="flex flex-col items-center">
                      <i class="fa fa-spinner fa-spin text-primary text-2xl mb-3"></i>
                      <span>加载中...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center">
            <div class="text-sm text-neutral">
              共 <span id="student-total-count" class="text-primary font-medium">0</span> 名学生
            </div>
            <div class="flex items-center gap-2" id="student-pagination">
              <button class="btn btn-outline px-3 py-1 text-sm" id="student-prev-page" disabled>
                <i class="fa fa-chevron-left"></i>
              </button>
              <span id="student-page-info" class="text-sm">第 1 页 / 共 0 页</span>
              <button class="btn btn-outline px-3 py-1 text-sm" id="student-next-page" disabled>
                <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 论文管理面板 -->
      <div id="paper-management-panel" class="tab-panel hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-5 border-b border-gray-200 flex flex-wrap justify-between items-center gap-4">
            <h3 class="font-medium">论文管理</h3>
            <div class="flex items-center gap-3">
              <div class="relative">
                <input type="text" id="paper-search-input" placeholder="搜索论文标题..." class="form-input pl-9 pr-4 py-2 w-64">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral"></i>
              </div>
              <div class="relative">
                <select id="paper-category-select" class="form-input pr-8 py-2 w-48">
                  <option value="">所有分类</option>
                </select>
                <i class="fa fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-neutral"></i>
              </div>
              <button id="paper-search-btn" class="btn btn-outline">
                <i class="fa fa-search mr-1"></i> 搜索
              </button>
              <button id="add-paper-btn" class="btn btn-primary">
                <i class="fa fa-plus mr-1"></i> 添加论文
              </button>
            </div>
          </div>

          <!-- 表格区域 -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                  <th class="text-left px-6 py-4 font-medium text-neutral">序号</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">论文标题</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">ArXiv ID</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">分类</th>
                  <th class="text-left px-6 py-4 font-medium text-neutral">操作</th>
                </tr>
              </thead>
              <tbody id="paper-table-body">
                <!-- 加载状态 -->
                <tr>
                  <td colspan="5" class="px-6 py-12 text-center text-neutral">
                    <div class="flex flex-col items-center">
                      <i class="fa fa-spinner fa-spin text-primary text-2xl mb-3"></i>
                      <span>加载中...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center">
            <div class="text-sm text-neutral">
              共 <span id="paper-total-count" class="text-primary font-medium">0</span> 篇论文
            </div>
            <div class="flex items-center gap-2" id="paper-pagination">
              <button class="btn btn-outline px-3 py-1 text-sm" id="paper-prev-page" disabled>
                <i class="fa fa-chevron-left"></i>
              </button>
              <span id="paper-page-info" class="text-sm">第 1 页 / 共 0 页</span>
              <button class="btn btn-outline px-3 py-1 text-sm" id="paper-next-page" disabled>
                <i class="fa fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 确认删除模态框 -->
  <div id="delete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 transform transition-all">
      <h3 class="text-lg font-medium mb-2">确认删除</h3>
      <p id="delete-modal-message" class="text-neutral mb-6">您确定要删除这条记录吗？此操作不可撤销。</p>
      <div class="flex justify-end gap-3">
        <button id="cancel-delete" class="btn btn-outline">取消</button>
        <button id="confirm-delete" class="btn bg-red-600 text-white hover:bg-red-700">删除</button>
      </div>
    </div>
  </div>

  <!-- 重置密码模态框 -->
  <div id="reset-password-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 transform transition-all">
      <h3 class="text-lg font-medium mb-2">重置密码</h3>
      <p id="reset-password-modal-message" class="text-neutral mb-6">您确定要重置该学生的密码吗？重置后密码将恢复为默认值。</p>
      <div class="flex justify-end gap-3">
        <button id="cancel-reset-password" class="btn btn-outline">取消</button>
        <button id="confirm-reset-password" class="btn btn-primary">确认重置</button>
      </div>
    </div>
  </div>

  <!-- 添加论文模态框 -->
  <div id="add-paper-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 transform transition-all max-h-[90vh] overflow-y-auto">
      <h3 class="text-lg font-medium mb-4">添加新论文</h3>
      <form id="add-paper-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="text-sm font-medium">论文标题 <span class="text-red-500">*</span></label>
            <input type="text" id="paper-title" name="title" class="form-input" required>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">ArXiv ID <span class="text-red-500">*</span></label>
            <input type="text" id="paper-arxiv-id" name="arxiv_id" class="form-input" required>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">分类 <span class="text-red-500">*</span></label>
            <select id="paper-category" name="category_id" class="form-input" required>
              <option value="">请选择分类</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">DOI</label>
            <input type="text" id="paper-doi" name="doi" class="form-input">
          </div>
          <div class="space-y-2 md:col-span-2">
            <label class="text-sm font-medium">PDF链接 <span class="text-red-500">*</span></label>
            <input type="url" id="paper-pdf-url" name="pdf_url" class="form-input" required>
          </div>
          <div class="space-y-2 md:col-span-2">
            <label class="text-sm font-medium">摘要</label>
            <textarea id="paper-abstract" name="abstract" rows="4" class="form-input"></textarea>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
          <button type="button" id="cancel-add-paper" class="btn btn-outline">取消</button>
          <button type="submit" class="btn btn-primary">提交</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // 全局状态
    let currentUser = {};
    let currentDeleteId = null;
    let currentDeleteType = ''; // 'history', 'student', 'paper'
    let currentResetStudentId = null;
    
    // 分页状态
    const studentPageState = { page: 1, per_page: 10, total: 0, pages: 0 };
    const paperPageState = { page: 1, per_page: 20, total: 0, pages: 0, category_id: '', search: '' };
    
    // DOM元素
    const tabItems = document.querySelectorAll('.sidebar-item');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const mainTitle = document.getElementById('main-title');
    const refreshBtn = document.getElementById('refresh-btn');
    const currentUsernameEl = document.getElementById('current-username');
    
    // 浏览记录相关
    const historyTableBody = document.getElementById('history-table-body');
    const totalCountEl = document.getElementById('total-count');
    const emptyState = document.getElementById('empty-state');
    
    // 学生管理相关
    const studentTableBody = document.getElementById('student-table-body');
    const studentSearchInput = document.getElementById('student-search-input');
    const studentSearchBtn = document.getElementById('student-search-btn');
    const studentTotalCountEl = document.getElementById('student-total-count');
    const studentPageInfo = document.getElementById('student-page-info');
    const studentPrevPageBtn = document.getElementById('student-prev-page');
    const studentNextPageBtn = document.getElementById('student-next-page');
    
    // 论文管理相关
    const paperTableBody = document.getElementById('paper-table-body');
    const paperSearchInput = document.getElementById('paper-search-input');
    const paperCategorySelect = document.getElementById('paper-category-select');
    const paperSearchBtn = document.getElementById('paper-search-btn');
    const addPaperBtn = document.getElementById('add-paper-btn');
    const paperTotalCountEl = document.getElementById('paper-total-count');
    const paperPageInfo = document.getElementById('paper-page-info');
    const paperPrevPageBtn = document.getElementById('paper-prev-page');
    const paperNextPageBtn = document.getElementById('paper-next-page');
    const paperCategoryModalSelect = document.getElementById('paper-category');
    
    // 模态框相关
    const deleteModal = document.getElementById('delete-modal');
    const deleteModalMessage = document.getElementById('delete-modal-message');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    
    const resetPasswordModal = document.getElementById('reset-password-modal');
    const cancelResetPasswordBtn = document.getElementById('cancel-reset-password');
    const confirmResetPasswordBtn = document.getElementById('confirm-reset-password');
    
    const addPaperModal = document.getElementById('add-paper-modal');
    const addPaperForm = document.getElementById('add-paper-form');
    const cancelAddPaperBtn = document.getElementById('cancel-add-paper');

    // 初始化页面
    document.addEventListener('DOMContentLoaded', () => {
      // 加载用户信息
      loadUserInfo();
      
      // 绑定选项卡切换事件
      tabItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const tabId = item.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
      
      // 绑定刷新按钮事件
      refreshBtn.addEventListener('click', refreshCurrentTab);
      
      // 绑定模态框事件
      cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.classList.add('hidden');
      });
      
      confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
      
      cancelResetPasswordBtn.addEventListener('click', () => {
        resetPasswordModal.classList.add('hidden');
      });
      
      confirmResetPasswordBtn.addEventListener('click', handleConfirmResetPassword);
      
      cancelAddPaperBtn.addEventListener('click', () => {
        addPaperModal.classList.add('hidden');
      });
      
      addPaperForm.addEventListener('submit', handleAddPaperSubmit);
      
      // 绑定学生管理事件
      studentSearchBtn.addEventListener('click', () => {
        studentPageState.page = 1;
        fetchStudents();
      });
      
      studentPrevPageBtn.addEventListener('click', () => {
        if (studentPageState.page > 1) {
          studentPageState.page--;
          fetchStudents();
        }
      });
      
      studentNextPageBtn.addEventListener('click', () => {
        if (studentPageState.page < studentPageState.pages) {
          studentPageState.page++;
          fetchStudents();
        }
      });
      
      // 绑定论文管理事件
      paperSearchBtn.addEventListener('click', () => {
        paperPageState.page = 1;
        paperPageState.search = paperSearchInput.value.trim();
        paperPageState.category_id = paperCategorySelect.value;
        fetchPapers();
      });
      
      paperPrevPageBtn.addEventListener('click', () => {
        if (paperPageState.page > 1) {
          paperPageState.page--;
          fetchPapers();
        }
      });
      
      paperNextPageBtn.addEventListener('click', () => {
        if (paperPageState.page < paperPageState.pages) {
          paperPageState.page++;
          fetchPapers();
        }
      });
      
      addPaperBtn.addEventListener('click', () => {
        addPaperModal.classList.remove('hidden');
        // 重置表单
        addPaperForm.reset();
      });
    });

    // 切换选项卡
    function switchTab(tabId) {
      // 更新导航栏激活状态
      tabItems.forEach(item => {
        if (item.getAttribute('data-tab') === tabId) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      
      // 更新面板显示状态
      tabPanels.forEach(panel => {
        if (panel.id === `${tabId}-panel`) {
          panel.classList.remove('hidden');
        } else {
          panel.classList.add('hidden');
        }
      });
      
      // 更新标题
      switch(tabId) {
        case 'click-history':
          mainTitle.textContent = '论文浏览记录';
          fetchClickHistory();
          break;
        case 'student-management':
          mainTitle.textContent = '学生管理';
          fetchStudents();
          break;
        case 'paper-management':
          mainTitle.textContent = '论文管理';
          fetchCategories();
          fetchPapers();
          break;
      }
    }

    // 刷新当前激活的选项卡
    function refreshCurrentTab() {
      const activeTab = document.querySelector('.sidebar-item.active');
      if (activeTab) {
        const tabId = activeTab.getAttribute('data-tab');
        switch(tabId) {
          case 'click-history':
            fetchClickHistory();
            break;
          case 'student-management':
            fetchStudents();
            break;
          case 'paper-management':
            fetchPapers();
            break;
        }
        showToast('已刷新数据');
      }
    }

    // 加载用户信息
    function loadUserInfo() {
      try {
        const userInfoStr = localStorage.getItem('userInfo');

        console.log('加载用户信息:', userInfoStr);

        if (userInfoStr) {
          currentUser = JSON.parse(userInfoStr);
          currentUsernameEl.textContent = currentUser.real_name || currentUser.username;
          
          // 验证管理员是否有学院ID
          if (!currentUser.college_id) {
            showToast('当前管理员账号缺少学院信息，请联系系统管理员', 'error');
          }
          
          // 默认加载浏览记录
          fetchClickHistory();
        } else {
          console.warn('未找到用户信息，请先登录');
          renderNotLoggedInState('history-table-body');
          renderNotLoggedInState('student-table-body', 4);
          renderNotLoggedInState('paper-table-body', 5);
          currentUsernameEl.textContent = '未登录';
        }
      } catch (error) {
        console.error('加载用户信息失败:', error);
        renderErrorState('history-table-body', '用户信息加载失败', 4);
        renderErrorState('student-table-body', '用户信息加载失败', 4);
        renderErrorState('paper-table-body', '用户信息加载失败', 5);
      }
    }

    // 渲染未登录状态
    function renderNotLoggedInState(tableId, colSpan = 4) {
      const tableBody = document.getElementById(tableId);
      tableBody.innerHTML = `
        <tr>
          <td colspan="${colSpan}" class="px-6 py-16 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
              <i class="fa fa-user-times text-2xl text-neutral"></i>
            </div>
            <h3 class="text-lg font-medium mb-1">未登录</h3>
            <p class="text-neutral max-w-md mx-auto mb-4">请先登录系统以查看相关数据</p>
            <a href="/user/login" class="btn bg-primary text-white hover:bg-primary/90">
              前往登录
            </a>
          </td>
        </tr>
      `;
    }

    // 渲染错误状态
    function renderErrorState(tableId, message, colSpan = 4) {
      const tableBody = document.getElementById(tableId);
      tableBody.innerHTML = `
        <tr>
          <td colspan="${colSpan}" class="px-6 py-16 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
              <i class="fa fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium mb-1">加载失败</h3>
            <p class="text-neutral max-w-md mx-auto mb-4">${message}</p>
            <button onclick="refreshCurrentTab()" class="btn btn-outline">
              重试
            </button>
          </td>
        </tr>
      `;
    }

    // ==================== 浏览记录功能 ====================
    // 获取浏览记录
    async function fetchClickHistory() {
      try {
        if (!currentUser || !currentUser.user_id) {
          showToast('用户信息无效，请重新登录', 'error');
          renderNotLoggedInState('history-table-body');
          return;
        }

        // 显示加载状态
        historyTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-12 text-center text-neutral">
              <div class="flex flex-col items-center">
                <i class="fa fa-spinner fa-spin text-primary text-2xl mb-3"></i>
                <span>加载中...</span>
              </div>
            </td>
          </tr>
        `;

        // API调用
        const response = await fetch(`/college_admin/api/click-history?user_id=${currentUser.user_id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.code === 200) {
          renderHistoryTable(data.data);
          totalCountEl.textContent = data.data.length;

          // 显示空状态或表格
          if (data.data.length === 0) {
            emptyState.classList.remove('hidden');
            historyTableBody.innerHTML = '';
          } else {
            emptyState.classList.add('hidden');
          }
        } else {
          showToast('获取记录失败: ' + data.message, 'error');
          renderErrorState('history-table-body', '数据加载失败: ' + data.message);
        }
      } catch (error) {
        console.error('获取浏览记录失败:', error);
        showToast('网络错误，无法获取记录', 'error');
        renderErrorState('history-table-body', '网络连接失败');
      }
    }

    // 渲染浏览记录表格
    function renderHistoryTable(records) {
      historyTableBody.innerHTML = '';

      if (records.length === 0) {
        historyTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-16 text-center">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                <i class="fa fa-folder-open-o text-2xl text-neutral"></i>
              </div>
              <h3 class="text-lg font-medium mb-1">暂无浏览记录</h3>
              <p class="text-neutral max-w-md mx-auto">请先浏览一些论文，记录将在这里显示</p>
            </td>
          </tr>
        `;
        totalCountEl.textContent = '0';
        return;
      }

      records.forEach((record, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 table-row-hover';
        row.innerHTML = `
          <td class="px-6 py-4">${index + 1}</td>
          <td class="px-6 py-4 max-w-md">
            <a href="${record.pdf_url}" target="_blank" class="text-primary hover:underline truncate block">
              ${record.paper_title || '未知论文'}
            </a>
          </td>
          <td class="px-6 py-4 text-neutral">${record.click_time}</td>
          <td class="px-6 py-4">
            <button
              class="btn btn-danger delete-btn"
              data-id="${record.click_id}"
              data-type="history"
            >
              <i class="fa fa-trash-o mr-1"></i> 删除
            </button>
          </td>
        `;

        historyTableBody.appendChild(row);
      });

      // 绑定删除按钮事件
      bindDeleteButtons();
    }

    // ==================== 学生管理功能 ====================
    // 获取学生列表 (核心修改：添加college_id参数传递)
    async function fetchStudents() {
      try {
        // 1. 校验用户信息和学院ID
        if (!currentUser) {
          showToast('用户信息无效，请重新登录', 'error');
          renderNotLoggedInState('student-table-body');
          return;
        }
        
        if (!currentUser.college_id) {
          showToast('当前管理员缺少学院ID信息，无法查看学生列表', 'error');
          renderErrorState('student-table-body', '管理员账号未绑定学院，请联系系统管理员', 4);
          return;
        }

        // 2. 显示加载状态
        studentTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-12 text-center text-neutral">
              <div class="flex flex-col items-center">
                <i class="fa fa-spinner fa-spin text-primary text-2xl mb-3"></i>
                <span>加载中...</span>
              </div>
            </td>
          </tr>
        `;

        // 3. 构建查询参数 (关键：添加college_id)
        const params = new URLSearchParams({
          college_id: currentUser.college_id,  // 传递管理员所属学院ID
          page: studentPageState.page,
          per_page: studentPageState.per_page,
          search: studentSearchInput.value.trim()
        });

        // 4. API调用
        const response = await fetch(`/college_admin/api/students?${params.toString()}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        // 5. 处理响应
        if (data.code === 200) {
          renderStudentTable(data.data.students);
          studentPageState.total = data.data.total;
          studentPageState.pages = data.data.pages;
          
          studentTotalCountEl.textContent = data.data.total;
          studentPageInfo.textContent = `第 ${studentPageState.page} 页 / 共 ${studentPageState.pages} 页`;
          
          // 更新分页按钮状态
          studentPrevPageBtn.disabled = studentPageState.page <= 1;
          studentNextPageBtn.disabled = studentPageState.page >= studentPageState.pages;
        } else {
          showToast('获取学生列表失败: ' + data.message, 'error');
          renderErrorState('student-table-body', '数据加载失败: ' + data.message);
        }
      } catch (error) {
        console.error('获取学生列表失败:', error);
        showToast('网络错误，无法获取学生列表', 'error');
        renderErrorState('student-table-body', '网络连接失败');
      }
    }

    // 渲染学生表格
    function renderStudentTable(students) {
      studentTableBody.innerHTML = '';

      if (students.length === 0) {
        studentTableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-16 text-center">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                <i class="fa fa-users text-2xl text-neutral"></i>
              </div>
              <h3 class="text-lg font-medium mb-1">暂无学生数据</h3>
              <p class="text-neutral max-w-md mx-auto">该学院暂无学生信息</p>
            </td>
          </tr>
        `;
        return;
      }

      students.forEach((student, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 table-row-hover';
        row.innerHTML = `
          <td class="px-6 py-4">${(studentPageState.page - 1) * studentPageState.per_page + index + 1}</td>
          <td class="px-6 py-4">${student.username || '-'}</td>
          <td class="px-6 py-4">${student.real_name || '-'}</td>
          <td class="px-6 py-4 flex gap-2">
            <button
              class="btn btn-outline reset-password-btn text-sm"
              data-id="${student.user_id}"
            >
              <i class="fa fa-refresh mr-1"></i> 重置密码
            </button>
            <button
              class="btn btn-danger delete-btn text-sm"
              data-id="${student.user_id}"
              data-type="student"
            >
              <i class="fa fa-trash-o mr-1"></i> 删除
            </button>
          </td>
        `;

        studentTableBody.appendChild(row);
      });

      // 绑定按钮事件
      bindDeleteButtons();
      bindResetPasswordButtons();
    }

    // 重置学生密码
    async function resetStudentPassword(studentId) {
      try {
        const response = await fetch(`/college_admin/api/reset_password/${studentId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.code === 200) {
          showToast('密码重置成功');
          resetPasswordModal.classList.add('hidden');
          fetchStudents();
        } else {
          showToast('密码重置失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('重置密码失败:', error);
        showToast('网络错误，密码重置失败', 'error');
      }
    }

    // ==================== 论文管理功能 ====================
    // 获取分类列表
    async function fetchCategories() {
      try {
        const response = await fetch('/college_admin/api/categories', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.code === 200) {
          // 填充分类下拉框
          const categories = data.data;
          paperCategorySelect.innerHTML = '<option value="">所有分类</option>';
          paperCategoryModalSelect.innerHTML = '<option value="">请选择分类</option>';
          
          categories.forEach(category => {
            const option1 = document.createElement('option');
            option1.value = category.category_id;
            option1.textContent = category.name;
            paperCategorySelect.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = category.category_id;
            option2.textContent = category.name;
            paperCategoryModalSelect.appendChild(option2);
          });
        } else {
          showToast('获取分类失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('获取分类失败:', error);
        showToast('网络错误，无法获取分类', 'error');
      }
    }

    // 获取论文列表
    async function fetchPapers() {
      try {
        // 显示加载状态
        paperTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-12 text-center text-neutral">
              <div class="flex flex-col items-center">
                <i class="fa fa-spinner fa-spin text-primary text-2xl mb-3"></i>
                <span>加载中...</span>
              </div>
            </td>
          </tr>
        `;

        // 构建查询参数
        const params = new URLSearchParams({
          page: paperPageState.page,
          per_page: paperPageState.per_page,
          search: paperPageState.search,
        });
        
        if (paperPageState.category_id) {
          params.append('category_id', paperPageState.category_id);
        }

        // API调用
        const response = await fetch(`/college_admin/api/papers?${params.toString()}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.code === 200) {
          renderPaperTable(data.data.papers);
          paperPageState.total = data.data.total;
          paperPageState.pages = data.data.pages;
          
          paperTotalCountEl.textContent = data.data.total;
          paperPageInfo.textContent = `第 ${paperPageState.page} 页 / 共 ${paperPageState.pages} 页`;
          
          // 更新分页按钮状态
          paperPrevPageBtn.disabled = paperPageState.page <= 1;
          paperNextPageBtn.disabled = paperPageState.page >= paperPageState.pages;
        } else {
          showToast('获取论文列表失败: ' + data.message, 'error');
          renderErrorState('paper-table-body', '数据加载失败: ' + data.message, 5);
        }
      } catch (error) {
        console.error('获取论文列表失败:', error);
        showToast('网络错误，无法获取论文列表', 'error');
        renderErrorState('paper-table-body', '网络连接失败', 5);
      }
    }

    // 渲染论文表格
    function renderPaperTable(papers) {
      paperTableBody.innerHTML = '';

      if (papers.length === 0) {
        paperTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-16 text-center">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                <i class="fa fa-file-text-o text-2xl text-neutral"></i>
              </div>
              <h3 class="text-lg font-medium mb-1">暂无论文数据</h3>
              <p class="text-neutral max-w-md mx-auto">点击"添加论文"按钮添加新论文</p>
            </td>
          </tr>
        `;
        return;
      }

      papers.forEach((paper, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 table-row-hover';
        row.innerHTML = `
          <td class="px-6 py-4">${(paperPageState.page - 1) * paperPageState.per_page + index + 1}</td>
          <td class="px-6 py-4 max-w-md">
            <a href="${paper.pdf_url}" target="_blank" class="text-primary hover:underline truncate block">
              ${paper.title || '-'}
            </a>
          </td>
          <td class="px-6 py-4">${paper.arxiv_id || '-'}</td>
          <td class="px-6 py-4">${paper.category_name || '-'}</td>
          <td class="px-6 py-4">
            <button
              class="btn btn-danger delete-btn"
              data-id="${paper.paper_id}"
              data-type="paper"
            >
              <i class="fa fa-trash-o mr-1"></i> 删除
            </button>
          </td>
        `;

        paperTableBody.appendChild(row);
      });

      // 绑定删除按钮事件
      bindDeleteButtons();
    }

    // 添加论文
    async function addPaper(paperData) {
      try {
        const response = await fetch('/college_admin/api/papers', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(paperData)
        });

        const data = await response.json();

        if (data.code === 200) {
          showToast('论文添加成功');
          addPaperModal.classList.add('hidden');
          fetchPapers();
        } else {
          showToast('添加论文失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('添加论文失败:', error);
        showToast('网络错误，添加论文失败', 'error');
      }
    }

    // ==================== 通用功能 ====================
    // 绑定删除按钮事件
    function bindDeleteButtons() {
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentDeleteId = e.currentTarget.getAttribute('data-id');
          currentDeleteType = e.currentTarget.getAttribute('data-type');
          
          // 更新模态框消息
          switch(currentDeleteType) {
            case 'history':
              deleteModalMessage.textContent = '您确定要删除这条浏览记录吗？此操作不可撤销。';
              break;
            case 'student':
              deleteModalMessage.textContent = '您确定要删除该学生账号吗？此操作不可撤销。';
              break;
            case 'paper':
              deleteModalMessage.textContent = '您确定要删除该论文吗？此操作不可撤销。';
              break;
          }
          
          deleteModal.classList.remove('hidden');
        });
      });
    }

    // 绑定重置密码按钮事件
    function bindResetPasswordButtons() {
      document.querySelectorAll('.reset-password-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentResetStudentId = e.currentTarget.getAttribute('data-id');
          resetPasswordModal.classList.remove('hidden');
        });
      });
    }

    // 处理确认删除
    async function handleConfirmDelete() {
      try {
        let url = '';
        let params = {};
        
        switch(currentDeleteType) {
          case 'history':
            url = `/college_admin/api/click-history/${currentDeleteId}?user_id=${currentUser.user_id}`;
            break;
          case 'student':
            url = `/college_admin/api/delete_student/${currentDeleteId}`;
            break;
          case 'paper':
            url = `/college_admin/api/papers/${currentDeleteId}`;
            break;
        }

        const response = await fetch(url, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.code === 200) {
          showToast('删除成功');
          deleteModal.classList.add('hidden');
          
          // 重新加载对应数据
          switch(currentDeleteType) {
            case 'history':
              fetchClickHistory();
              break;
            case 'student':
              fetchStudents();
              break;
            case 'paper':
              fetchPapers();
              break;
          }
        } else {
          showToast('删除失败: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('删除失败:', error);
        showToast('网络错误，删除失败', 'error');
      }
    }

    // 处理确认重置密码
    async function handleConfirmResetPassword() {
      await resetStudentPassword(currentResetStudentId);
    }

    // 处理添加论文提交
    function handleAddPaperSubmit(e) {
      e.preventDefault();
      
      const paperData = {
        title: document.getElementById('paper-title').value.trim(),
        arxiv_id: document.getElementById('paper-arxiv-id').value.trim(),
        category_id: parseInt(document.getElementById('paper-category').value),
        doi: document.getElementById('paper-doi').value.trim(),
        abstract: document.getElementById('paper-abstract').value.trim(),
        pdf_url: document.getElementById('paper-pdf-url').value.trim()
      };
      
      addPaper(paperData);
    }

    // 显示提示消息
    function showToast(message, type = 'success') {
      // 创建toast元素
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 right-6 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 transition-all duration-300 transform translate-y-10 opacity-0`;

      // 设置样式
      if (type === 'success') {
        toast.classList.add('bg-green-50', 'text-green-600', 'border', 'border-green-200');
        toast.innerHTML = `<i class="fa fa-check-circle"></i><span>${message}</span>`;
      } else {
        toast.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-200');
        toast.innerHTML = `<i class="fa fa-exclamation-circle"></i><span>${message}</span>`;
      }

      // 添加到页面
      document.body.appendChild(toast);

      // 显示动画
      setTimeout(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
      }, 10);

      // 3秒后隐藏
      setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>